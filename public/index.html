<!DOCTYPE html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>nyanko_test</title>
	<script src="/js/dhtmlxgantt.js"></script>
	<!-- <script type="text/javascript" src="/js/kaslab.js" charset="UTF-8"></script> -->
	<!-- <link href="/css/dhtmlxgantt.css" rel="stylesheet"> -->
	<link href="/skins/dhtmlxgantt_broadway_mod.css" rel="stylesheet">
	<link href="/css/controls_styles.css" rel="stylesheet">


	<style type="text/css">
		html, body{
			height:100%;
			padding:0px;
			margin:0px;
			overflow: hidden;
		}
		/* 色分け */
		.high {
			border: 2px solid #d96c49;
			color: #d96c49;
			background: #d96c49;
		}

		.high .gantt_task_progress {
			background: #db2536;
		}

		.medium {
			border: 2px solid #34c461;
			color: #34c461;
			background: #34c461;
		}

		.medium .gantt_task_progress {
			background: #23964d;
		}

		.low {
			border: 2px solid #6ba8e3;
			color: #6ba8e3;
			background: #6ba8e3;
		}

		.low .gantt_task_progress {
			background: #547dab;
		}
	</style>
	<link rel="shortcut icon" href="">
</head>

<body>

<!-- フォーム -->
<form class="gantt_control">

	<!-- ズーム用 -->
	<!-- <input type="button" value="Zoom In" onclick="zoomIn()">
	<input type="button" value="Zoom Out" onclick="zoomOut()"> -->

	<input type="radio" id="scale1" class="gantt_radio" name="scale" value="day">
	<label for="scale1">Day scale</label>

	<!-- <input type="radio" id="scale2" class="gantt_radio" name="scale" value="week">
	<label for="scale2">Week scale</label> -->

	<input type="radio" id="scale3" class="gantt_radio" name="scale" value="month" checked>
	<label for="scale3">Month scale</label>

	<input type="radio" id="scale4" class="gantt_radio" name="scale" value="quarter">
	<label for="scale4">Quarter scale</label>

	<input type="radio" id="scale5" class="gantt_radio" name="scale" value="year">
	<label for="scale5">Year scale</label>

</form>

<div id="gantt_here" style='width:100%; height:calc(100vh - 52px);'></div>
<!-- <div id="gantt_here" style="width: 100%; height: 100vh;"></div> -->

<script type="text/javascript">

	// プラグイン
	gantt.plugins({
		keyboard_navigation: true,
		undo: true,
		marker: true 
	});

	// 現在の線
	var dateToStr = gantt.date.date_to_str(gantt.config.task_date);
 
	var id = gantt.addMarker({ 
		start_date: new Date(), 
		css: "today", 
		text: "Now",
		title:dateToStr(new Date())
	});
	setInterval(function(){
		var today = gantt.getMarker(id);
		today.start_date = new Date();
		today.title = date_to_str(today.start_date);
		gantt.updateMarker(id);
	}, 1000*60);

	// 色
	gantt.locale.labels.section_barColor = "Color";
	gantt.locale.labels.section_textColor = "Text Color";

	var colors = [
		{key: "", label: "Default"},
		{key: "#4B0082", label: "Indigo"},
		{key: "#FFFFF0", label: "Ivory"},
		{key: "#F0E68C", label: "Khaki"},
		{key: "#B0C4DE", label: "LightSteelBlue"},
		{key: "#32CD32", label: "LimeGreen"},
		{key: "#7B68EE", label: "MediumSlateBlue"},
		{key: "#FFA500", label: "Orange"},
		{key: "#FF4500", label: "OrangeRed"}
	];

	gantt.config.lightbox.sections = [
		{name: "description", height: 38, map_to: "text", type: "textarea", focus: true},
	    {name:"priority", height:22, map_to:"priority", type:"select", options: [ 
        {key:1, label: "High"},                                               
        {key:2, label: "Normal"},                                             
        {key:3, label: "Low"}                                                 
     	]},
		{name: "barColor", height: 22, map_to: "color", type: "select", options: colors},
		{name: "textColor", height: 22, map_to: "textColor", type: "select", options: colors},
		{name: "time", type: "duration", map_to: "auto"}
	];

	// 左側欄の設定

	var textEditor = {type: "text", map_to: "text"};
	// var dateEditor = {type: "date", map_to: "start_date", min: new Date(2018, 0, 1), max: new Date(2019, 0, 1)};
	var durationEditor = {type: "number", map_to: "duration", min:0, max: 100};
	var priority = {type: "select", map_to: "priority", options:gantt.serverList("priority")};

	gantt.config.columns=[
		{name:"text",       label:"タスク名",  tree:true, width: 300 , editor: textEditor},
		{name:"start_date", label:"開始", align: "center", width: 80 },
		{
			name: "priority", label: "Priority", align: "center", template: function (obj) {
				if (obj.priority == 1) {
					return "High"
				}
				if (obj.priority == 2) {
					return "Medium"
				}
				return "Low"
			},
			editor: priority
		},
		{name:"duration",   label:"期間",  align: "center", width: 50 , editor: durationEditor},
		{name:"add",        label:"" , width: 35 }
	];


	// 色付け

	gantt.templates.task_class = function (start, end, task) {
		switch (task.priority) {
			case "1":
				return "high";
				break;
			case "2":
				return "medium";
				break;
			case "3":
				return "low";
				break;
		}
	};

	// タスクのバーの右側のテキスト設定
	gantt.templates.rightside_text = function(start, end, task){
    return task.text + " " + task.duration + "<b>日</b>";};

	// スケールの設定
	var zoomConfig = {
		levels: [
			{
				name:"day",
				scale_height: 60,
				min_column_width:50,
				scales:[
					{unit: "month", format: "%F, %Y"},
					{unit: "day", step: 1, format: "%j %D"}
				]
			},
			// {
			// 	name:"week",
			// 	scale_height: 60,
			// 	min_column_width:30,
			// 	scales:[
			// 		{unit: "week", step: 1, format: function (date) {
			// 			var dateToStr = gantt.date.date_to_str("%d %M");
			// 			var endDate = gantt.date.add(date, 6, "day");
			// 			var weekNum = gantt.date.date_to_str("%W")(date);
			// 			return "#" + weekNum + ", " + dateToStr(date) + " - " + dateToStr(endDate);
			// 			// return dateToStr(date) + " - " + dateToStr(endDate);
			// 		}},
			// 		// {unit: "day", step: 1, format: "%j"}
			// 		{unit: "day", step: 1, format: "%j"},
			// 		{unit: "day", step: 1, format: "%D"}
			// 	]
			// },
			{
				name:"month",
				scale_height: 70,
				min_column_width:30,
				scales:[
					{unit: "month", format: "%F, %Y"},
					{unit: "week", format: "Week #%W"},
					{unit: "day", step: 1, format: "%j"},
					{unit: "day", step: 1, format: "%D"}
				]
			},
			{
				name:"quarter",
				scale_height: 70,
				min_column_width:33,
				scales:[
					{unit: "year", step: 1, format: "%Y"},
					{unit: "month", format: "%F"},
					{
						unit: "quarter", step: 1, format: function (date) {
							var dateToStr = gantt.date.date_to_str("%M");
							var endDate = gantt.date.add(gantt.date.add(date, 3, "month"), -1, "day");
							return dateToStr(date) + " - " + dateToStr(endDate);
						}
					},
					{unit: "week", format: "#%W"},
				]
			},
			{
				name:"year",
				scale_height: 60,
				min_column_width: 60,
				scales:[
					{unit: "year", step: 1, format: "%Y"},
					{unit: "month", format: "%F"},
				]
			}
		]
	};

	gantt.ext.zoom.init(zoomConfig);
	gantt.ext.zoom.setLevel("month");
	gantt.ext.zoom.attachEvent("onAfterZoom", function(level, config){
		document.querySelector(".gantt_radio[value='" +config.name+ "']").checked = true;
	})

	// function zoomIn(){
	// 	gantt.ext.zoom.zoomIn();
	// }
	// function zoomOut(){
	// 	gantt.ext.zoom.zoomOut()
	// }

	var radios = document.getElementsByName("scale");
	for (var i = 0; i < radios.length; i++) {
		radios[i].onclick = function (event) {
			gantt.ext.zoom.setLevel(event.target.value);
		};
	}


	// キーボードナビゲーション
	gantt.message({
		text: "<p>Keyboard shortcuts:</p>" +
		"<b>Global</b>" +
		"<ul>" +
		"<li><b>Tab</b> - select gantt</li>" +
		"<li><b>Alt + Up/Down/Left/Right</b> - scroll gantt</li>" +
		"<li><b>Ctrl + Enter</b> - create new task</li>" +
		"<li><b>Ctrl + Z</b> - undo</li>" +
		"<li><b>Ctrl + R</b> - redo</li>" +
		"</ul>" +
		"<b>Header Cells</b>" +
		"<ul>" +
		"<li><b>Left/Right</b> - navigate over cells</li>" +

		"<li><b>Home/End</b> - navigate to the first/last column</li>" +
		"<li><b>Down</b> - navigate to task rows</li>" +
		"<li><b>Space/Enter</b> - click header</li>" +
		"</ul>" +
		"<b>Task cells</b>" +
		"<ul>" +
		"<li><b>Up/Down/Left/Right</b> - navigate cells</li>" +
		"<li><b>PageDown/PageUp</b> - navigate to the first/last cell in column</li>" +
		"<li><b>Home/End</b> - navigate to the first/last cell in row</li>" +
		"<li><b>Space</b> - select task</li>" +
		"<li><b>Ctrl + Enter</b> - create new task</li>" +
		"<li><b>Delete</b> - delete selected task</li>" +
		"<li><b>Enter</b> - open the lightbox</li>" +
		"<li><b>Ctrl + Left/Right</b> - expand, collapse tree</li>" +
		"</ul>",
		expire: -1
	});

	// 設定
	gantt.config.order_branch = true;/*!*/
	gantt.config.order_branch_free = true;/*!*/
	gantt.config.date_format="%Y-%m-%d";
	gantt.config.sort = true;
	gantt.config.keyboard_navigation_cells = true;


	// 開いた時に展開する
	gantt.config.open_tree_initially = true;

	// init
	gantt.init("gantt_here");



	// 開いたときに開始日でソード
	gantt.sort("start_date", false);

	// スクロール
	var scroll_state, click, original_mouse_position;
	var timeline_area = document.getElementsByClassName("gantt_task_bg")[0]
	var timeline_area_2 = document.getElementsByClassName("gantt_task_scale")[0]
	

	timeline_area.onmousedown = function(event){
		click = true;
		scroll_state = gantt.getScrollState().x;
		original_mouse_position = event.clientX;
	}
	timeline_area_2.onmousedown = function(event){
		click = true;
		scroll_state = gantt.getScrollState().x;
		original_mouse_position = event.clientX;
	}

	window.onmouseup = function(event){
		click = false;
	}

	gantt.attachEvent("onMouseMove", function (id, e){
		var scroll_value = scroll_state + original_mouse_position - e.clientX
		if (click) { gantt.scrollTo(scroll_value, null);
		}
	});


	// ローカルストレージの利用
	var initialData = {
		data: localStorage["task"] ? JSON.parse(localStorage["task"]) : [],
		links: localStorage["link"] ? JSON.parse(localStorage["link"]) : []
	}

	gantt.parse(initialData);

	var dp = gantt.createDataProcessor(function(mode, taskState, data, rowId) {
		var workData = [];

		if (localStorage[mode]) {
			workData = JSON.parse(localStorage[mode]);
		}

		switch(taskState) {
			case "create":
				workData.push(data);
			break;
			case "update":
				var itemIndex = workData.findIndex(function(entry, index) {
					return entry.id == rowId;
				});
				workData[itemIndex] = data;
			break;
			break;
			case "delete":
				var itemIndex = workData.findIndex(function(entry, index) {
					return entry.id == rowId;
				});
				workData.splice(itemIndex, 1);
			break;
		}
		
		localStorage[mode] = JSON.stringify(workData);
	});

</script>

</body>