<!DOCTYPE html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>nyanko_test</title>
	<script src="/js/dhtmlxgantt.js"></script>
	<!-- <script type="text/javascript" src="/js/kaslab.js" charset="UTF-8"></script> -->
	<link href="/css/dhtmlxgantt.css" rel="stylesheet">
	<link href="/css/controls_styles.css?v=7.1.8" rel="stylesheet">


	<style type="text/css">
		html, body{
			height:100%;
			padding:0px;
			margin:0px;
			overflow: hidden;
		}
	</style>
	<link rel="shortcut icon" href="">
</head>

<body>
<!-- ズーム用 -->
<form class="gantt_control">
	<input type="button" value="Zoom In" onclick="zoomIn()">
	<input type="button" value="Zoom Out" onclick="zoomOut()">

	<input type="radio" id="scale1" class="gantt_radio" name="scale" value="day">
	<label for="scale1">Day scale</label>

	<input type="radio" id="scale2" class="gantt_radio" name="scale" value="week">
	<label for="scale2">Week scale</label>

	<input type="radio" id="scale3" class="gantt_radio" name="scale" value="month" checked>
	<label for="scale3">Month scale</label>

	<input type="radio" id="scale4" class="gantt_radio" name="scale" value="quarter">
	<label for="scale4">Quarter scale</label>

	<input type="radio" id="scale5" class="gantt_radio" name="scale" value="year">
	<label for="scale5">Year scale</label>

</form>

<div id="gantt_here" style='width:100%; height:calc(100vh - 52px);'></div>
<!-- <div id="gantt_here" style="width: 100%; height: 100vh;"></div> -->

<script type="text/javascript">

	// 左側欄の設定

	var textEditor = {type: "text", map_to: "text"};
	// var dateEditor = {type: "date", map_to: "start_date", min: new Date(2018, 0, 1), max: new Date(2019, 0, 1)};
	var durationEditor = {type: "number", map_to: "duration", min:0, max: 100};
	// var priority = {type: "select", map_to: "priority", options:gantt.serverList("priority")};

	gantt.config.columns=[
		{name:"text",       label:"Task name",  tree:true, width: 300, editor: textEditor},
		{name:"start_date", label:"Start time", align: "center", width: 71 },
		{name:"duration",   label:"Duration",  align: "center", width: 50 , editor: durationEditor},
		{name:"add",        label:"" , width: 40 }
	];
	
	// タスクのバーの右側のテキスト設定
	gantt.templates.rightside_text = function(start, end, task){
    return task.text + " " + task.duration + "<b>日</b>";};

	// スケールの設定
	var zoomConfig = {
		levels: [
			{
				name:"day",
				scale_height: 35,
				min_column_width:18,
				scales:[
					{unit: "month", format: "%F, %Y"},
					{unit: "day", step: 1, format: "%j"}
				]
			},
			{
				name:"week",
				scale_height: 50,
				min_column_width:30,
				scales:[
					{unit: "week", step: 1, format: function (date) {
						var dateToStr = gantt.date.date_to_str("%d %M");
						var endDate = gantt.date.add(date, 6, "day");
						var weekNum = gantt.date.date_to_str("%W")(date);
						return "#" + weekNum + ", " + dateToStr(date) + " - " + dateToStr(endDate);
						// return dateToStr(date) + " - " + dateToStr(endDate);
					}},
					// {unit: "day", step: 1, format: "%j"}
					{unit: "day", step: 1, format: "%j"},
					{unit: "day", step: 1, format: "%D"}
				]
			},
			{
				name:"month",
				scale_height: 50,
				min_column_width:20,
				scales:[
					{unit: "month", format: "%F, %Y"},
					{unit: "week", format: "Week #%W"},
					{unit: "day", step: 1, format: "%j"}
				]
			},
			{
				name:"quarter",
				height: 50,
				min_column_width:30,
				scales:[
					// {unit: "month", step: 1, format: "%M"},
					{unit: "month", format: "%F, %Y"},
					{
						unit: "quarter", step: 1, format: function (date) {
							var dateToStr = gantt.date.date_to_str("%M");
							var endDate = gantt.date.add(gantt.date.add(date, 3, "month"), -1, "day");
							return dateToStr(date) + " - " + dateToStr(endDate);
						}
					},
					{unit: "week", format: "#%W"},
				]
			},
			{
				name:"year",
				scale_height: 50,
				min_column_width: 60,
				scales:[
					{unit: "year", step: 1, format: "%Y"},
					{unit: "month", format: "%F"},
				]
			}
		]
	};

	gantt.ext.zoom.init(zoomConfig);
	gantt.ext.zoom.setLevel("month");
	gantt.ext.zoom.attachEvent("onAfterZoom", function(level, config){
		document.querySelector(".gantt_radio[value='" +config.name+ "']").checked = true;
	})

	function zoomIn(){
		gantt.ext.zoom.zoomIn();
	}
	function zoomOut(){
		gantt.ext.zoom.zoomOut()
	}

	var radios = document.getElementsByName("scale");
	for (var i = 0; i < radios.length; i++) {
		radios[i].onclick = function (event) {
			gantt.ext.zoom.setLevel(event.target.value);
		};
	}

	// 設定
	gantt.config.order_branch = true;/*!*/
	gantt.config.order_branch_free = true;/*!*/

	gantt.config.date_format="%Y-%m-%d %H:%i";

	gantt.init("gantt_here");


	// スクロール
	var scroll_state, click, original_mouse_position;
	var timeline_area = document.getElementsByClassName("gantt_task_bg")[0]
	

	timeline_area.onmousedown = function(event){
		click = true;
		scroll_state = gantt.getScrollState().x;
		original_mouse_position = event.clientX;
	}


	window.onmouseup = function(event){
		click = false;
	}

	gantt.attachEvent("onMouseMove", function (id, e){
		var scroll_value = scroll_state + original_mouse_position - e.clientX
		if (click) { gantt.scrollTo(scroll_value, null);
		}
	});


	// ローカルストレージの利用
	var initialData = {
		data: localStorage["task"] ? JSON.parse(localStorage["task"]) : [],
		links: localStorage["link"] ? JSON.parse(localStorage["link"]) : []
	}

	gantt.parse(initialData);

	var dp = gantt.createDataProcessor(function(mode, taskState, data, rowId) {
		var workData = [];

		if (localStorage[mode]) {
			workData = JSON.parse(localStorage[mode]);
		}

		switch(taskState) {
			case "create":
				workData.push(data);
			break;
			case "update":
				var itemIndex = workData.findIndex(function(entry, index) {
					return entry.id == rowId;
				});
				workData[itemIndex] = data;
			break;
			break;
			case "delete":
				var itemIndex = workData.findIndex(function(entry, index) {
					return entry.id == rowId;
				});
				workData.splice(itemIndex, 1);
			break;
		}
		
		localStorage[mode] = JSON.stringify(workData);
	});

</script>

</body>